name: Unit Tests

on: push

jobs:
  run-tests:
    runs-on: ${{ matrix.os }}

    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest]

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          submodules: true

      - name: Build
        run: make

      - name: Cache Tables
        id: cache-tables
        uses: actions/cache@v4
        with:
          path: cache
          key: cache-tables

      - name: Build Tables
        if: steps.cache-tables.outputs.cache-hit != 'true'
        run: ./cubotron --rebuild-tables

      - name: Run Tests
        run: make test
